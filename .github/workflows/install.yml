name: Privacera Manager Install

on:
  workflow_dispatch:
    inputs:
      gcp_project_id:
        description: 'GCP Project ID'
        required: true
        type: string
      gcp_region:
        description: 'GCP region or zone for deployment (e.g., "us-central1" for regional, "us-central1-c" for zonal cluster)'
        required: true
        default: 'us-central1'
        type: string
      gke_cluster_name:
        description: 'GKE cluster name (just the name, e.g., "cust-demo", not the full context path)'
        required: true
        type: string
      skip_helm_validation:
        description: 'Skip Helm chart validation'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  install:
    name: Install Privacera Manager
    runs-on: self-hosted
    
    env:
      PRIVACERA_VERSION: ""
      PRIVACERA_HUB_SERVER: ""
      DEPLOYMENT_ENV_NAME: ""
      GCP_PROJECT_ID: ${{ github.event.inputs.gcp_project_id }}
      GCP_REGION: ${{ github.event.inputs.gcp_region }}
      GKE_CLUSTER_NAME: ${{ github.event.inputs.gke_cluster_name }}
      SKIP_HELM_VALIDATION: ${{ github.event.inputs.skip_helm_validation }}
      DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
      PRIV_MGR_IMAGE: ""
      PRIV_MGR_PACKAGE: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check workflow_dispatch event
        run: |
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "âŒ ERROR: This workflow can only be run via workflow_dispatch"
            echo "   Please go to Actions tab â†’ Click 'Run workflow' â†’ Select branch"
            exit 1
          fi

      - name: Install prerequisites
        run: |
          echo "ðŸ“¦ Installing prerequisites..."
          
          # Remove problematic PostgreSQL repository if it exists
          echo "ðŸ§¹ Cleaning up problematic apt repositories..."
          sudo rm -f /etc/apt/sources.list.d/pgdg*.list 2>/dev/null || true
          sudo rm -f /etc/apt/sources.list.d/postgresql*.list 2>/dev/null || true
          
          # Also remove any other potentially problematic third-party repos
          # that might cause issues on self-hosted runners
          for repo_file in /etc/apt/sources.list.d/*.list; do
            if [ -f "$repo_file" ]; then
              # Check if repo is accessible, if not, disable it
              repo_name=$(basename "$repo_file")
              echo "  Checking: $repo_name"
            fi
          done
          
          # Clean apt cache after removing repos
          sudo apt-get clean
          
          # Update package lists (with error tolerance for any remaining bad repos)
          echo "ðŸ“‹ Updating package lists..."
          sudo apt-get update -qq 2>&1 | grep -v "does not have a Release file" || true
          
          # Install core dependencies
          echo "ðŸ“¦ Installing core packages..."
          sudo apt-get install -y -qq \
            curl \
            tar \
            gzip \
            wget \
            openssl \
            hostname \
            sudo \
            unzip \
            python3 \
            python3-pip \
            apt-transport-https \
            ca-certificates \
            gnupg \
            lsb-release \
            || { echo "âš ï¸ Some packages may have failed, continuing..."; }
          
          # Install Google Cloud SDK
          echo "â˜ï¸ Installing Google Cloud SDK..."
          if ! command -v gcloud &> /dev/null; then
            # Remove any existing Google Cloud SDK repo config to start fresh
            sudo rm -f /etc/apt/sources.list.d/google-cloud-sdk.list 2>/dev/null || true
            
            # Add Google Cloud SDK repository
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
              sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
            
            # Add the GPG key
            curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
              sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg 2>/dev/null || \
              curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
              sudo apt-key add -
            
            # Update and install
            sudo apt-get update -qq 2>&1 | grep -v "does not have a Release file" || true
            sudo apt-get install -y -qq google-cloud-cli google-cloud-cli-gke-gcloud-auth-plugin || {
              echo "âš ï¸ apt install failed, trying snap..."
              sudo snap install google-cloud-cli --classic 2>/dev/null || {
                echo "âš ï¸ snap failed, trying direct download..."
                curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-linux-x86_64.tar.gz
                tar -xf google-cloud-cli-linux-x86_64.tar.gz
                ./google-cloud-sdk/install.sh --quiet --path-update=true
                export PATH="$PATH:$(pwd)/google-cloud-sdk/bin"
                echo "$(pwd)/google-cloud-sdk/bin" >> $GITHUB_PATH
              }
            }
          else
            echo "âœ… gcloud already installed"
          fi
          
          # Verify gcloud installation
          if command -v gcloud &> /dev/null; then
            gcloud --version
          else
            echo "âŒ ERROR: gcloud installation failed"
            exit 1
          fi
          
          # Install gke-gcloud-auth-plugin if not already installed
          if ! command -v gke-gcloud-auth-plugin &> /dev/null; then
            echo "ðŸ”Œ Installing gke-gcloud-auth-plugin..."
            sudo apt-get install -y -qq google-cloud-cli-gke-gcloud-auth-plugin 2>/dev/null || \
              gcloud components install gke-gcloud-auth-plugin --quiet 2>/dev/null || \
              echo "âš ï¸ gke-gcloud-auth-plugin installation deferred"
          fi
          
          # Install kubectl
          echo "ðŸ”§ Installing kubectl..."
          if ! command -v kubectl &> /dev/null; then
            KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
            curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          else
            echo "âœ… kubectl already installed"
          fi
          kubectl version --client
          
          # Install Helm
          echo "âŽˆ Installing Helm..."
          if ! command -v helm &> /dev/null; then
            curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          else
            echo "âœ… Helm already installed"
          fi
          helm version
          
          # Install Ansible and PyYAML
          echo "ðŸ“š Installing Python packages..."
          pip3 install --break-system-packages ansible-core>=2.12.0 PyYAML 2>/dev/null || \
            pip3 install --user ansible-core>=2.12.0 PyYAML 2>/dev/null || \
            pip3 install ansible-core PyYAML
          
          echo "âœ… All prerequisites installed successfully"

      - name: Authenticate to GCP
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Load configuration from variables.env
        run: |
          echo "ðŸ”§ Loading configuration from variables.env..."
          
          if [ ! -f "variables.env" ]; then
            echo "âŒ ERROR: variables.env file not found!"
            echo "Please ensure variables.env exists with PRIVACERA_VERSION and PRIVACERA_HUB_SERVER"
            exit 1
          fi
          
          echo "âœ… Found variables.env file"
          source variables.env
          
          # Set deployment environment name (defaults to branch name)
          DEPLOYMENT_ENV_NAME="${DEPLOYMENT_ENV_NAME:-${{ github.ref_name }}}"
          
          # Export variables for subsequent steps
          {
            echo "PRIVACERA_VERSION=${PRIVACERA_VERSION}"
            echo "PRIVACERA_HUB_SERVER=${PRIVACERA_HUB_SERVER}"
            echo "DEPLOYMENT_ENV_NAME=${DEPLOYMENT_ENV_NAME}"
            echo "PRIV_MGR_IMAGE=${PRIVACERA_HUB_SERVER}/privacera-manager:${PRIVACERA_VERSION}"
            echo "PRIV_MGR_PACKAGE=https://privacera-releases.s3.us-east-1.amazonaws.com/privacera-manager/${PRIVACERA_VERSION}/privacera-manager.tar.gz"
          } >> $GITHUB_ENV
          
          echo "âœ… Configuration loaded:"
          echo "   - PRIVACERA_VERSION: ${PRIVACERA_VERSION}"
          echo "   - PRIVACERA_HUB_SERVER: ${PRIVACERA_HUB_SERVER}"
          echo "   - DEPLOYMENT_ENV_NAME: ${DEPLOYMENT_ENV_NAME}"

      - name: Validate configuration
        env:
          PRIVACERA_HUB_USER: ${{ secrets.PRIVACERA_HUB_USER }}
          PRIVACERA_HUB_PASSWORD: ${{ secrets.PRIVACERA_HUB_PASSWORD }}
        run: |
          echo "ðŸ” Validating configuration..."
          ERRORS=""
          
          # Check environment variables
          [ -z "$PRIVACERA_VERSION" ] && ERRORS="${ERRORS}\n  - PRIVACERA_VERSION not set in variables.env"
          [ -z "$PRIVACERA_HUB_SERVER" ] && ERRORS="${ERRORS}\n  - PRIVACERA_HUB_SERVER not set in variables.env"
          [ -z "$DEPLOYMENT_ENV_NAME" ] && ERRORS="${ERRORS}\n  - DEPLOYMENT_ENV_NAME could not be determined"
          [ -z "$GCP_PROJECT_ID" ] && ERRORS="${ERRORS}\n  - GCP_PROJECT_ID is required (workflow input)"
          [ -z "$GCP_REGION" ] && ERRORS="${ERRORS}\n  - GCP_REGION is required (workflow input)"
          [ -z "$GKE_CLUSTER_NAME" ] && ERRORS="${ERRORS}\n  - GKE_CLUSTER_NAME is required (workflow input)"
          
          # Check secrets
          [ -z "$PRIVACERA_HUB_USER" ] && ERRORS="${ERRORS}\n  - PRIVACERA_HUB_USER secret not set"
          [ -z "$PRIVACERA_HUB_PASSWORD" ] && ERRORS="${ERRORS}\n  - PRIVACERA_HUB_PASSWORD secret not set"
          
          if [ -n "$ERRORS" ]; then
            echo "âŒ ERROR: Configuration validation failed:"
            echo -e "$ERRORS"
            exit 1
          fi
          
          echo "âœ… All required configuration is valid"

      - name: Setup GKE cluster credentials
        run: |
          echo "â˜¸ï¸ Setting up GKE cluster credentials..."
          
          # Check if kubectl is already configured
          if kubectl cluster-info --request-timeout=5s &>/dev/null; then
            echo "âœ… kubectl is already configured"
            kubectl config current-context
          else
            echo "ðŸ”§ Fetching GKE cluster credentials..."
            
            # Detect if location is a zone or region
            # Zones have format: region-zone (e.g., us-central1-c)
            # Regions have format: region (e.g., us-central1)
            case "${GCP_REGION}" in
              *-[a-z])
                LOCATION_FLAG="--zone=${GCP_REGION}"
                echo "ðŸ“ Detected zonal cluster: ${GCP_REGION}"
                ;;
              *)
                LOCATION_FLAG="--region=${GCP_REGION}"
                echo "ðŸ“ Detected regional cluster: ${GCP_REGION}"
                ;;
            esac
            
            # Try internal IP first (recommended for self-hosted runners on GKE)
            echo "ðŸ”— Attempting to get credentials with internal IP..."
            if gcloud container clusters get-credentials "${GKE_CLUSTER_NAME}" \
                ${LOCATION_FLAG} \
                --project="${GCP_PROJECT_ID}" \
                --internal-ip 2>&1; then
              echo "âœ… Using internal IP endpoint"
            else
              echo "âš ï¸ Internal IP failed, trying external endpoint..."
              gcloud container clusters get-credentials "${GKE_CLUSTER_NAME}" \
                ${LOCATION_FLAG} \
                --project="${GCP_PROJECT_ID}"
            fi
          fi
          
          # Verify cluster access
          echo ""
          echo "ðŸ” Verifying cluster access..."
          if kubectl cluster-info --request-timeout=10s; then
            echo "âœ… Cluster is accessible"
          else
            echo "âŒ ERROR: Cannot access cluster"
            echo ""
            echo "Troubleshooting:"
            echo "  1. Verify the cluster name: ${GKE_CLUSTER_NAME}"
            echo "  2. Verify the region/zone: ${GCP_REGION}"
            echo "  3. Check if the cluster is private and requires VPN/bastion"
            echo "  4. Verify service account has 'container.clusters.get' permission"
            exit 1
          fi
          
          echo ""
          echo "ðŸ“‹ Current context: $(kubectl config current-context)"

      - name: Display configuration
        run: |
          echo "=== GCP Deployment Configuration ==="
          echo "Deployment Environment: ${DEPLOYMENT_ENV_NAME}"
          echo "GCP Project ID: ${GCP_PROJECT_ID}"
          echo "GCP Region/Zone: ${GCP_REGION}"
          echo "GKE Cluster Name: ${GKE_CLUSTER_NAME}"
          echo "Privacera Version: ${PRIVACERA_VERSION}"
          echo "Privacera Hub Server: ${PRIVACERA_HUB_SERVER}"
          echo "Debug Mode: ${DEBUG_MODE}"
          echo "Skip Helm Validation: ${SKIP_HELM_VALIDATION}"
          echo "===================================="

      - name: Login to Privacera Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.PRIVACERA_HUB_SERVER }}
          username: ${{ secrets.PRIVACERA_HUB_USER }}
          password: ${{ secrets.PRIVACERA_HUB_PASSWORD }}

      - name: Create namespace
        run: |
          echo "ðŸ“¦ Creating namespace '${DEPLOYMENT_ENV_NAME}'..."
          kubectl create namespace "${DEPLOYMENT_ENV_NAME}" --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Namespace '${DEPLOYMENT_ENV_NAME}' is ready"

      - name: Download installation scripts
        run: |
          echo "ðŸ“¥ Downloading installation scripts..."
          BASE_URL="https://raw.githubusercontent.com/privacera/privacera-installation-scripts/refs/heads/main/base-install"
          
          curl -fsSL "${BASE_URL}/install_pm.sh" -o install_pm.sh
          curl -fsSL "${BASE_URL}/bootstrap_privacera.sh" -o bootstrap_privacera.sh
          curl -fsSL "${BASE_URL}/self-managed/gcp/gcp_pm_config_env.sh" -o gcp_pm_config_env.sh 2>/dev/null || echo "GCP script not found, will create config manually"
          
          # Fix non-portable cp -n commands
          for script in install_pm.sh bootstrap_privacera.sh; do
            if [ -f "$script" ]; then
              sed -i 's/cp -n/cp/g; s/cp -nv/cp -v/g; s/cp -nrv/cp -rv/g' "$script"
            fi
          done
          
          chmod +x *.sh
          echo "âœ… Installation scripts downloaded"

      - name: Configure environment variables
        env:
          PRIVACERA_HUB_USER: ${{ secrets.PRIVACERA_HUB_USER }}
          PRIVACERA_HUB_PASSWORD: ${{ secrets.PRIVACERA_HUB_PASSWORD }}
        run: |
          echo "âš™ï¸ Configuring environment variables..."
          
          cat > gcp_pm_config_env.sh << 'ENVEOF'
          # GCP Environment Configuration
          DEPLOYMENT_ENV_TYPE="GCP"
          ENVEOF
          
          cat >> gcp_pm_config_env.sh << EOF
          DEPLOYMENT_ENV_NAME="${DEPLOYMENT_ENV_NAME}"
          PRIV_MGR_IMAGE="${PRIV_MGR_IMAGE}"
          PRIV_MGR_PACKAGE="${PRIV_MGR_PACKAGE}"
          PRIVACERA_HUB_USER="${PRIVACERA_HUB_USER}"
          PRIVACERA_HUB_PASSWORD="${PRIVACERA_HUB_PASSWORD}"
          GCP_PROJECT_ID="${GCP_PROJECT_ID}"
          GCP_REGION="${GCP_REGION}"
          
          export DEPLOYMENT_ENV_TYPE DEPLOYMENT_ENV_NAME PRIV_MGR_IMAGE PRIV_MGR_PACKAGE
          export PRIVACERA_HUB_USER PRIVACERA_HUB_PASSWORD
          export GCP_PROJECT_ID GCP_REGION
          EOF
          
          echo "âœ… Environment configuration created"

      - name: Run installation script
        run: |
          echo "ðŸš€ Setting up Privacera Manager..."
          export HOME="${GITHUB_WORKSPACE}"
          cd "${HOME}"
          
          CONFIG_FILE="gcp_pm_config_env.sh"
          
          # Run installation
          bash install_pm.sh "${CONFIG_FILE}" || {
            if [ -d "${HOME}/privacera/privacera-manager" ]; then
              echo "âš ï¸ Script exited with warnings but installation directory exists"
            else
              echo "âŒ Installation failed"
              exit 1
            fi
          }
          
          # Run bootstrap
          bash bootstrap_privacera.sh "${CONFIG_FILE}" || {
            if [ -d "${HOME}/privacera/privacera-manager/config" ]; then
              echo "âš ï¸ Script exited with warnings but config directory exists"
            else
              echo "âŒ Bootstrap failed"
              exit 1
            fi
          }
          
          # Use custom-vars from repo if available
          if [ -d "${GITHUB_WORKSPACE}/custom-vars" ] && [ -n "$(ls -A ${GITHUB_WORKSPACE}/custom-vars 2>/dev/null)" ]; then
            echo "ðŸ“ Using custom-vars from repository..."
            rm -rf "${HOME}/privacera/privacera-manager/config/custom-vars/"*
            cp -rv "${GITHUB_WORKSPACE}/custom-vars/"* "${HOME}/privacera/privacera-manager/config/custom-vars/"
          else
            echo "ðŸ“ Using generated custom-vars..."
            rm -f "${HOME}/privacera/privacera-manager/config/custom-vars/vars.privacera-secrets.yml"
            rm -f "${HOME}/privacera/privacera-manager/config/custom-vars/vars.encrypt.secrets.yml"
          fi
          
          # Copy to workspace for artifacts
          mkdir -p "${GITHUB_WORKSPACE}/privacera-manager"
          cp -rv "${HOME}/privacera/privacera-manager/"* "${GITHUB_WORKSPACE}/privacera-manager/"
          
          echo "âœ… Privacera Manager setup complete"

      - name: Generate Helm charts
        run: |
          echo "âŽˆ Generating Helm charts..."
          cd "${GITHUB_WORKSPACE}/privacera-manager"
          ./privacera-manager.sh setup
          
          mkdir -p "${GITHUB_WORKSPACE}/helm-charts-output"
          cp -rv output/kubernetes/helm/* "${GITHUB_WORKSPACE}/helm-charts-output/" 2>/dev/null || echo "âš ï¸ No helm charts to copy"
          
          echo "âœ… Helm charts generated"

      - name: Fix deprecated Kubernetes API versions
        run: |
          echo "ðŸ”§ Fixing deprecated Kubernetes API versions..."
          
          find privacera-manager/output/kubernetes/helm/ -type f \( -name "*.yaml" -o -name "*.yml" \) 2>/dev/null | while read -r file; do
            sed -i \
              -e 's|rbac.authorization.k8s.io/v1beta1|rbac.authorization.k8s.io/v1|g' \
              -e 's|policy/v1beta1|policy/v1|g' \
              -e 's|extensions/v1beta1|apps/v1|g' \
              -e 's|networking.k8s.io/v1beta1|networking.k8s.io/v1|g' \
              "$file" 2>/dev/null || true
          done
          
          echo "âœ… API versions updated"

      - name: Deploy to Kubernetes
        run: |
          echo "ðŸš€ Deploying to Kubernetes..."
          cd "${GITHUB_WORKSPACE}/privacera-manager"
          source "${GITHUB_WORKSPACE}/gcp_pm_config_env.sh"
          
          chmod +x ./pm_with_helm.sh
          ./pm_with_helm.sh upgrade
          ./privacera-manager.sh setup && ./pm_with_helm.sh install
          
          # Wait for LoadBalancer IPs
          echo "â³ Waiting for LoadBalancer services..."
          PORTAL_IPS_FILE="${GITHUB_WORKSPACE}/portal-ips.txt"
          
          for i in {1..30}; do
            kubectl -n "${DEPLOYMENT_ENV_NAME}" get svc -o jsonpath='{range .items[?(@.spec.type=="LoadBalancer")]}{.metadata.name}{"\t"}{.status.loadBalancer.ingress[0].ip}{"\n"}{end}' 2>/dev/null | while IFS=$'\t' read -r svc ip; do
              [ -n "$ip" ] && echo "$svc: $ip" >> "$PORTAL_IPS_FILE"
            done
            
            [ -s "$PORTAL_IPS_FILE" ] && break
            sleep 10
          done
          
          # Display service URLs
          cat output/service-urls.txt 2>/dev/null || echo "âš ï¸ service-urls.txt not found"
          
          ./privacera-manager.sh post-install
          
          echo "âœ… Deployment completed"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: privacera-install-artifacts
          path: |
            helm-charts-output/
            privacera-manager/
            portal-ips.txt
          retention-days: 7
          if-no-files-found: warn

      - name: Display deployment status
        run: |
          echo ""
          echo "========================================"
          echo "       DEPLOYMENT SUMMARY"
          echo "========================================"
          echo "Environment: ${DEPLOYMENT_ENV_NAME}"
          echo "Platform: GCP (GKE)"
          echo "Project: ${GCP_PROJECT_ID}"
          echo "Region/Zone: ${GCP_REGION}"
          echo "Cluster: ${GKE_CLUSTER_NAME}"
          echo "Privacera Version: ${PRIVACERA_VERSION}"
          echo "========================================"
          echo ""
          
          if [ -f "${GITHUB_WORKSPACE}/portal-ips.txt" ]; then
            echo "ðŸ“ Portal IP Addresses:"
            cat "${GITHUB_WORKSPACE}/portal-ips.txt"
            echo ""
          fi
          
          echo "ðŸ“¦ Pods:"
          kubectl get pods -n "${DEPLOYMENT_ENV_NAME}" 2>/dev/null || echo "Unable to get pods"
          echo ""
          
          echo "ðŸŒ Services:"
          kubectl get svc -n "${DEPLOYMENT_ENV_NAME}" 2>/dev/null || echo "Unable to get services"
          echo ""
          
          echo "âœ… Deployment complete!"

      - name: Cleanup sensitive files
        if: always()
        run: |
          # Remove the temporary key file
          rm -f "${GCP_KEY_FILE}" 2>/dev/null || true
          rm -f "${RUNNER_TEMP}/gcp-service-account-key.json" 2>/dev/null || true
          echo "ðŸ§¹ Cleanup complete"
